<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Release Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #a4-container {
            max-width: 210mm; 
            margin-left: auto;
            margin-right: auto;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        /* Styles for the drag-and-drop area */
        #drop-zone {
            border: 2px dashed #cbd5e1;
            transition: border-color 0.2s, background-color 0.2s;
        }
        #drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="max-w-5xl mx-auto p-4 md:p-8">
        <!-- TABS for switching views -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6">
                <button id="generator-tab-button" onclick="switchView('form-view')" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200 ease-in-out active">
                    Generator
                </button>
                <button id="history-tab-button" onclick="switchView('history-view')" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200 ease-in-out">
                    History
                </button>
            </nav>
        </div>

        <!-- FORM VIEW -->
        <div id="form-view">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <input type="hidden" id="editing-id"> <!-- Hidden input to store the ID of the document being edited -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 id="form-title" class="text-3xl font-bold text-gray-900">Technical Release Generator</h1>
                        <p class="text-gray-600">Fill in the details below to create a new document.</p>
                    </div>
                    <div class="text-right">
                        <label for="ref-number-input" class="block text-sm font-medium text-gray-700 text-right">Reference Number</label>
                        <input type="text" id="ref-number-input" class="w-48 mt-1 px-3 py-2 border border-gray-300 rounded-lg text-right font-bold text-blue-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Loading...">
                    </div>
                </div>
                <div class="space-y-6">
                    <!-- Form fields -->
                    <div>
                        <label for="productsAffected" class="block text-sm font-medium text-gray-700 mb-1">Products Affected</label>
                        <input type="text" id="productsAffected" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Alpha Motors, Sonesse 30 WireFree">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Release Category</label>
                        <select id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option>Motors</option> <option>Fabrics</option> <option>Hardware</option> <option>Software</option> <option>Installation Procedure</option> <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" id="title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Somfy Zigbee Motors and Tahoma Pro">
                    </div>
                    <div>
                        <label for="effectiveDate" class="block text-sm font-medium text-gray-700 mb-1">Effective Date</label>
                        <input type="date" id="effectiveDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="overview" class="block text-sm font-medium text-gray-700 mb-1">Overview</label>
                        <textarea id="overview" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Provide a brief overview of the technical release."></textarea>
                        <button onclick="refineText('overview')" class="mt-2 px-3 py-1.5 text-xs font-semibold text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200 transition flex items-center gap-2">
                            <span class="refine-text">Refine with AI</span> <span class="spinner hidden"></span>
                        </button>
                    </div>
                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-700 mb-1">Details</label>
                        <textarea id="details" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Provide the specific details, features, or changes."></textarea>
                        <button onclick="refineText('details')" class="mt-2 px-3 py-1.5 text-xs font-semibold text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200 transition flex items-center gap-2">
                            <span class="refine-text">Refine with AI</span> <span class="spinner hidden"></span>
                        </button>
                    </div>
                    <!-- Drag and Drop Image Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Images</label>
                        <div id="drop-zone" class="flex justify-center items-center w-full p-8 rounded-lg cursor-pointer">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">
                                    <span class="font-semibold">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            </div>
                            <input type="file" id="images" multiple accept="image/*" class="hidden">
                        </div>
                        <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                        <button id="generate-headings-button" onclick="generateImageHeadings()" class="hidden mt-4 px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 transition flex items-center gap-2">
                            <span class="refine-text">Generate Image Headings with AI</span> <span class="spinner hidden"></span>
                        </button>
                    </div>
                    <div>
                        <label for="impact" class="block text-sm font-medium text-gray-700 mb-1">Impact and Action Required</label>
                        <textarea id="impact" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Explain the impact on users and what actions are required from them."></textarea>
                        <button onclick="refineText('impact')" class="mt-2 px-3 py-1.5 text-xs font-semibold text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200 transition flex items-center gap-2">
                            <span class="refine-text">Refine with AI</span> <span class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="generate-button" onclick="generateDocument()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                        Preview Document
                    </button>
                </div>
            </div>
        </div>

        <!-- HISTORY VIEW -->
        <div id="history-view" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Release History</h1>
                <div class="mb-6">
                    <input type="text" id="search-input" onkeyup="searchReleases()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Search by title, ref no, product, or any keyword...">
                </div>
                <div id="history-results" class="space-y-4">
                    <p class="text-gray-500">Loading history...</p>
                </div>
            </div>
        </div>

        <!-- DOCUMENT OUTPUT VIEW -->
        <div id="document-view" class="hidden">
             <div class="flex justify-end gap-2 mb-4">
                <button onclick="switchView('form-view')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Back to Editor</button>
                <button id="pdf-download-button" onclick="downloadPDF()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                    <span id="pdf-download-text">Download PDF</span>
                    <span id="pdf-download-spinner" class="spinner hidden"></span>
                </button>
                <button id="firebase-save-button" onclick="saveToFirebase()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                    <span id="firebase-save-text">Save to Firebase</span>
                    <span id="firebase-spinner" class="spinner hidden"></span>
                </button>
            </div>
            <div id="a4-container">
                <div id="document-output" class="bg-white p-8 md:p-12 rounded-xl shadow-lg border border-gray-200">
                     <header class="border-b pb-6 mb-8">
                        <h1 class="text-xl font-bold text-gray-800">Blind Designs Technical Release</h1>
                        <h2 id="output-title" class="text-3xl md:text-4xl font-bold text-gray-900 mt-4 break-words"></h2>
                        <div class="mt-6 grid grid-cols-3 gap-4 text-sm">
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Reference No.</p><p id="output-ref" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Release Date</p><p id="output-releaseDate" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Effective Date</p><p id="output-effectiveDate" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Category</p><p id="output-category" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg col-span-2"><p class="font-semibold text-gray-600">Products Affected</p><p id="output-products" class="text-gray-900 font-medium break-words"></p></div>
                        </div>
                    </header>
                    <main class="space-y-8">
                        <div id="output-overview-section"><h3 class="text-xl font-bold mb-3 text-gray-800 border-b-2 border-blue-200 pb-2">Overview</h3><p id="output-overview" class="text-gray-700 leading-relaxed whitespace-pre-wrap break-words"></p></div>
                        <div id="output-details-section"><h3 class="text-xl font-bold mb-3 text-gray-800 border-b-2 border-blue-200 pb-2">Details</h3><p id="output-details" class="text-gray-700 leading-relaxed whitespace-pre-wrap break-words"></p></div>
                        <div id="output-images-section" class="hidden"><h3 class="text-xl font-bold mb-3 text-gray-800 border-b-2 border-blue-200 pb-2">Images</h3><div id="output-images" class="mt-4 grid grid-cols-2 gap-4"></div></div>
                        <div id="output-impact-section"><div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg"><div class="flex"><div class="flex-shrink-0"><svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></div><div class="ml-3"><h3 class="text-lg font-bold text-yellow-800">Impact and Action Required</h3><div class="mt-2 text-sm text-yellow-700"><p id="output-impact" class="whitespace-pre-wrap"></p></div></div></div></div></div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, serverTimestamp, query, orderBy, runTransaction, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCAnOF4XM_sYW1-s4iEM7i3JmiB7zFCSkw",
          authDomain: "tech-release-generator.firebaseapp.com",
          projectId: "tech-release-generator",
          storageBucket: "tech-release-generator.appspot.com",
          messagingSenderId: "436027193031",
          appId: "1:436027193031:web:b4235e2f0e8ce025c730e2",
          measurementId: "G-2D5WVYH83J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.firebase = { db, storage, collection, addDoc, getDocs, ref, uploadBytes, getDownloadURL, doc, updateDoc, serverTimestamp, query, orderBy, runTransaction, getDoc, setDoc, deleteDoc, deleteObject };
        
        (async () => {
            try {
                await window.loadHistory();
                await window.updateRefDisplay();
            } catch (e) {
                console.error("Initial app load failed. This is likely a Firebase rules issue.", e);
            }
        })();
    </script>
    
    <script>
        const imageFiles = []; 
        let allReleases = []; 
        let suggestedRefNumber = '';

        async function getNextRefNumber() {
            const counterRef = window.firebase.doc(window.firebase.db, "_config", "releaseCounter");
            try {
                const counterSnap = await window.firebase.getDoc(counterRef);
                let currentCounter = 1;
                if (counterSnap.exists()) {
                    currentCounter = counterSnap.data().value;
                } else {
                    await window.firebase.setDoc(counterRef, { value: 1 });
                }
                const year = new Date().getFullYear();
                return `TR-${year}-${currentCounter.toString().padStart(3, '0')}`;
            } catch (error) {
                console.error("Could not fetch the next reference number:", error);
                return "TR-ERROR-1";
            }
        }
        
        async function updateRefDisplay() {
             suggestedRefNumber = await getNextRefNumber();
             document.getElementById('ref-number-input').value = suggestedRefNumber;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupDragAndDrop();
        });

        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('images');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            const preview = document.getElementById('image-preview');
            const headingsButton = document.getElementById('generate-headings-button');

            for (const file of files) {
                if (!file.type.startsWith('image/')){ continue }
                
                const fileId = `file-${Date.now()}-${Math.random()}`;
                const fileData = { id: fileId, file: file, src: '', heading: '' }; // src will be base64
                
                toBase64(file).then(base64_src => {
                    fileData.src = base64_src;
                    imageFiles.push(fileData);

                    const wrapper = document.createElement('div');
                    wrapper.id = fileId;
                    wrapper.className = 'relative group';

                    const img = document.createElement('img');
                    img.src = fileData.src;
                    img.className = 'w-full h-32 object-cover rounded-lg border';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'image-heading-input mt-2 w-full px-2 py-1 border border-gray-300 rounded-md text-sm';
                    input.placeholder = 'Image heading...';
                    input.oninput = () => {
                        fileData.heading = input.value;
                    };

                    wrapper.appendChild(img);
                    wrapper.appendChild(input);
                    preview.appendChild(wrapper);
                });
            }

            if (imageFiles.length > 0) {
                headingsButton.classList.remove('hidden');
            }
        }

        async function refineText(elementId) {
            const textarea = document.getElementById(elementId);
            const button = textarea.nextElementSibling;
            const spinner = button.querySelector('.spinner');
            const buttonText = button.querySelector('.refine-text');

            const originalText = textarea.value;
            if (!originalText.trim()) {
                alert("Please enter some text to refine.");
                return;
            }

            spinner.classList.remove('hidden');
            buttonText.textContent = 'Refining...';
            button.disabled = true;

            try {
                const prompt = `Rewrite and improve the following text for a professional technical release document. Enhance its clarity, grammar, and formal tone. Respond with only the improved text. Original text: "${originalText}"`;
                const refinedText = await callGemini(prompt, 'gemini-1.5-flash-latest');
                textarea.value = refinedText.trim();
            } catch (error) {
                console.error('Error refining text:', error);
                alert(`An error occurred while refining the text:\n\n${error.message}`);
            } finally {
                spinner.classList.add('hidden');
                buttonText.textContent = 'Refine with AI';
                button.disabled = false;
            }
        }
        
        async function generateImageHeadings() {
            const button = document.getElementById('generate-headings-button');
            const spinner = button.querySelector('.spinner');
            const buttonText = button.querySelector('.refine-text');

            if (imageFiles.length === 0) {
                alert("Please upload images first.");
                return;
            }
            
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Generating...';
            button.disabled = true;

            try {
                const context = `Title: ${document.getElementById('title').value}\nOverview: ${document.getElementById('overview').value}`;
                const promptParts = [{ text: `Based on the following context, generate a short, descriptive heading for each image.\n\nContext: ${context}\n\n` }];

                for (const fileData of imageFiles) {
                    promptParts.push({ inlineData: { mimeType: fileData.file.type, data: fileData.src.split(',')[1] } });
                    promptParts.push({ text: "\n" });
                }
                
                const schema = { type: "OBJECT", properties: { headings: { type: "ARRAY", items: { "type": "STRING" } } } };
                const resultText = await callGemini(promptParts, 'gemini-1.5-flash-latest', schema);
                const resultJson = JSON.parse(resultText);
                
                if (resultJson.headings && resultJson.headings.length === imageFiles.length) {
                    resultJson.headings.forEach((heading, index) => {
                        const fileData = imageFiles[index];
                        fileData.heading = heading;
                        const wrapper = document.getElementById(fileData.id);
                        if (wrapper) {
                            wrapper.querySelector('.image-heading-input').value = heading;
                        }
                    });
                } else {
                    throw new Error("AI did not return the expected number of headings.");
                }

            } catch (error) {
                console.error('Error generating image headings:', error);
                alert(`An error occurred while generating image headings:\n\n${error.message}`);
            } finally {
                spinner.classList.add('hidden');
                buttonText.textContent = 'Generate Image Headings with AI';
                button.disabled = false;
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function callGemini(prompt, model, responseSchema = null) {
            const apiKey = "AIzaSyD1ouEcm7GhtDx3Cqs3GTtZulcETvRF9YU"; 
            const payload = { contents: [{ role: "user", parts: Array.isArray(prompt) ? prompt : [{ text: prompt }] }] };

            if (responseSchema) {
                payload.generationConfig = { responseMimeType: "application/json", responseSchema: responseSchema };
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorMsg = `API request failed with status ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.error && errorData.error.message) {
                        errorMsg = errorData.error.message;
                    }
                } catch (e) {
                    console.error("Could not parse error JSON from API response.", e);
                }
                console.error("Full API Error:", errorMsg);
                throw new Error(errorMsg);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                     throw new Error(`Request blocked due to: ${result.promptFeedback.blockReason}`);
                }
                console.error("Invalid response structure:", result);
                throw new Error("Received an invalid or empty response from the AI service.");
            }
        }

        function generateDocument() {
            const refNumber = document.getElementById('ref-number-input').value;
            
            document.getElementById('output-ref').textContent = refNumber;
            document.getElementById('output-products').textContent = document.getElementById('productsAffected').value;
            document.getElementById('output-category').textContent = document.getElementById('category').value;
            document.getElementById('output-title').textContent = document.getElementById('title').value || 'Untitled Release';
            
            const releaseDate = new Date().toLocaleDateString('en-CA');
            const effectiveDateRaw = document.getElementById('effectiveDate').value;
            const effectiveDate = effectiveDateRaw ? new Date(effectiveDateRaw + 'T00:00:00').toLocaleDateString('en-CA') : 'TBD';

            document.getElementById('output-releaseDate').textContent = releaseDate;
            document.getElementById('output-effectiveDate').textContent = effectiveDate;
            document.getElementById('output-overview').textContent = document.getElementById('overview').value;
            document.getElementById('output-details').textContent = document.getElementById('details').value;
            document.getElementById('output-impact').textContent = document.getElementById('impact').value;

            const imagesContainer = document.getElementById('output-images');
            imagesContainer.innerHTML = '';
            if (imageFiles.length > 0) {
                document.getElementById('output-images-section').classList.remove('hidden');
                imageFiles.forEach(fileData => {
                    const wrapper = document.createElement('div');
                    const heading = document.createElement('h4');
                    heading.className = 'text-md font-semibold text-gray-700 mb-2';
                    heading.textContent = fileData.heading || '';
                    const img = document.createElement('img');
                    img.src = fileData.src;
                    img.className = 'w-full rounded-lg shadow-md border';
                    img.crossOrigin = "anonymous";
                    wrapper.appendChild(heading);
                    wrapper.appendChild(img);
                    imagesContainer.appendChild(wrapper);
                });
            } else {
                 document.getElementById('output-images-section').classList.add('hidden');
            }

            switchView('document-view');
        }
        
        async function downloadPDF() {
            const button = document.getElementById('pdf-download-button');
            const buttonText = document.getElementById('pdf-download-text');
            const spinner = document.getElementById('pdf-download-spinner');

            buttonText.textContent = 'Generating...';
            spinner.classList.remove('hidden');
            button.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById('document-output');
                const canvas = await html2canvas(content, { scale: 2, useCORS: true });
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasAspectRatio = canvas.width / canvas.height;
                let finalImgWidth = pdfWidth;
                let finalImgHeight = pdfWidth / canvasAspectRatio;
                if (finalImgHeight > pdfHeight) {
                    finalImgHeight = pdfHeight;
                    finalImgWidth = pdfHeight * canvasAspectRatio;
                }
                const xOffset = (pdfWidth - finalImgWidth) / 2;
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', xOffset, 0, finalImgWidth, finalImgHeight);
                
                const refNumber = document.getElementById('output-ref').textContent;
                const titleText = document.getElementById('output-title').textContent || 'Untitled-Release';
                const fileName = `${refNumber}-${titleText.replace(/[\s/]/g, '-')}.pdf`;
                pdf.save(fileName);

            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Failed to generate PDF. Check console for details.");
            } finally {
                buttonText.textContent = 'Download PDF';
                spinner.classList.add('hidden');
                button.disabled = false;
            }
        }

        async function saveToFirebase() {
            const button = document.getElementById('firebase-save-button');
            const buttonText = document.getElementById('firebase-save-text');
            const spinner = document.getElementById('firebase-spinner');
            const editingId = document.getElementById('editing-id').value;

            buttonText.textContent = editingId ? 'Updating...' : 'Saving...';
            spinner.classList.remove('hidden');
            button.disabled = true;

            try {
                const userRefNumber = document.getElementById('output-ref').textContent;

                if (!editingId && userRefNumber === suggestedRefNumber) {
                    const counterRef = window.firebase.doc(window.firebase.db, "_config", "releaseCounter");
                    await window.firebase.runTransaction(window.firebase.db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        if (!counterDoc.exists()) throw "Counter document does not exist!";
                        const newCounterValue = counterDoc.data().value + 1;
                        transaction.update(counterRef, { value: newCounterValue });
                    });
                }
                
                const releaseData = {
                    refNumber: userRefNumber,
                    title: document.getElementById('output-title').textContent,
                    productsAffected: document.getElementById('output-products').textContent,
                    category: document.getElementById('output-category').textContent,
                    releaseDate: document.getElementById('output-releaseDate').textContent,
                    effectiveDate: document.getElementById('output-effectiveDate').textContent,
                    overview: document.getElementById('output-overview').textContent,
                    details: document.getElementById('output-details').textContent,
                    impact: document.getElementById('output-impact').textContent,
                    createdAt: window.firebase.serverTimestamp()
                };

                const { jsPDF } = window.jspdf;
                const content = document.getElementById('document-output');
                const canvas = await html2canvas(content, { scale: 2, useCORS: true });
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasAspectRatio = canvas.width / canvas.height;
                let finalImgWidth = pdfWidth;
                let finalImgHeight = pdfWidth / canvasAspectRatio;
                if (finalImgHeight > pdfHeight) {
                    finalImgHeight = pdfHeight;
                    finalImgWidth = pdfHeight * canvasAspectRatio;
                }
                const xOffset = (pdfWidth - finalImgWidth) / 2;
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', xOffset, 0, finalImgWidth, finalImgHeight);
                const pdfBlob = pdf.output('blob');

                const fileName = `${releaseData.refNumber}-${releaseData.title.replace(/[\s/]/g, '-')}.pdf`;
                const storageRef = window.firebase.ref(window.firebase.storage, `releases/${fileName}`);
                await window.firebase.uploadBytes(storageRef, pdfBlob);
                const downloadURL = await window.firebase.getDownloadURL(storageRef);
                releaseData.pdfUrl = downloadURL;

                if (editingId) {
                    const docRef = window.firebase.doc(window.firebase.db, "releases", editingId);
                    await window.firebase.updateDoc(docRef, releaseData);
                    alert('Successfully updated release!');
                } else {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, "releases"), releaseData);
                    alert('Successfully saved to Firebase!');
                }

                await window.loadHistory(); 
                switchView('history-view'); 

            } catch (error) {
                console.error("Error saving to Firebase: ", error);
                alert("Error saving to Firebase. Check the console for details.");
            } finally {
                buttonText.textContent = 'Save to Firebase';
                spinner.classList.add('hidden');
                button.disabled = false;
            }
        }
        
        window.loadHistory = async function() {
            try {
                const releasesRef = window.firebase.collection(window.firebase.db, "releases");
                const q = window.firebase.query(releasesRef, window.firebase.orderBy("createdAt", "desc"));
                const querySnapshot = await window.firebase.getDocs(q);
                allReleases = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayReleases(allReleases);
            } catch (error) {
                console.error("Error loading history: ", error);
                const historyResults = document.getElementById('history-results');
                historyResults.innerHTML = `<div class="text-red-100 border-l-4 border-red-500 bg-red-50 p-4" role="alert"><p class="font-bold text-red-800">Error Loading History</p><p class="text-red-700">Could not fetch data. Please ensure your Firebase Security Rules are set up correctly.</p></div>`;
            }
        }

        function displayReleases(releases) {
            const container = document.getElementById('history-results');
            if (releases.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No releases found.</p>';
                return;
            }
            container.innerHTML = releases.map(release => `
                <div class="border border-gray-200 p-4 rounded-lg flex justify-between items-center hover:bg-gray-50">
                    <div>
                        <p class="font-bold text-lg text-gray-800">${release.title}</p>
                        <p class="text-sm text-gray-600">${release.refNumber} | Products: ${release.productsAffected}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="${release.pdfUrl}" target="_blank" class="bg-green-100 text-green-800 font-semibold py-2 px-3 rounded-lg hover:bg-green-200 transition text-sm">View PDF</a>
                        <button onclick="editRelease('${release.id}')" class="bg-blue-100 text-blue-800 font-semibold py-2 px-3 rounded-lg hover:bg-blue-200 transition text-sm">Edit</button>
                        <button onclick="deleteRelease('${release.id}', '${release.refNumber}', '${release.title}')" class="bg-red-100 text-red-800 font-semibold py-2 px-3 rounded-lg hover:bg-red-200 transition text-sm">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        window.editRelease = function(id) {
            const release = allReleases.find(r => r.id === id);
            if (!release) return;

            document.getElementById('editing-id').value = id;
            document.getElementById('ref-number-input').value = release.refNumber || '';
            document.getElementById('productsAffected').value = release.productsAffected || '';
            document.getElementById('category').value = release.category || 'Motors';
            document.getElementById('title').value = release.title || '';
            document.getElementById('effectiveDate').value = release.effectiveDate || '';
            document.getElementById('overview').value = release.overview || '';
            document.getElementById('details').value = release.details || '';
            document.getElementById('impact').value = release.impact || '';
            
            imageFiles.length = 0;
            document.getElementById('image-preview').innerHTML = '<p class="text-sm text-gray-500 col-span-4">Images cannot be edited. Please re-upload if you need to change them.</p>';

            document.getElementById('form-title').textContent = 'Editing Technical Release';
            switchView('form-view');
        }

        window.deleteRelease = async function(id, refNumber, title) {
            if (!confirm('Are you sure you want to permanently delete this technical release? This action cannot be undone.')) {
                return;
            }

            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, "releases", id));
                
                const fileName = `${refNumber}-${title.replace(/[\s/]/g, '-')}.pdf`;
                const storageRef = window.firebase.ref(window.firebase.storage, `releases/${fileName}`);
                await window.firebase.deleteObject(storageRef);
                
                alert('Release deleted successfully.');
                await loadHistory();
            } catch (error) {
                console.error("Error deleting release: ", error);
                alert(`Failed to delete release: ${error.message}`);
            }
        }

        window.searchReleases = function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (!searchTerm) {
                displayReleases(allReleases);
                return;
            }
            const filtered = allReleases.filter(r => 
                (r.title && r.title.toLowerCase().includes(searchTerm)) ||
                (r.refNumber && r.refNumber.toLowerCase().includes(searchTerm)) ||
                (r.productsAffected && r.productsAffected.toLowerCase().includes(searchTerm)) ||
                (r.overview && r.overview.toLowerCase().includes(searchTerm)) ||
                (r.details && r.details.toLowerCase().includes(searchTerm)) ||
                (r.impact && r.impact.toLowerCase().includes(searchTerm))
            );
            displayReleases(filtered);
        }

        function switchView(viewId) {
            ['form-view', 'history-view', 'document-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            ['generator-tab-button', 'history-tab-button'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });

            if (viewId === 'form-view' || viewId === 'document-view') {
                document.getElementById('generator-tab-button').classList.add('active');
            } else if (viewId === 'history-view') {
                document.getElementById('history-tab-button').classList.add('active');
            }
            
            if (viewId === 'form-view' && !document.getElementById('editing-id').value) {
                startNewRelease();
            }
        }

        async function startNewRelease() {
            document.getElementById('editing-id').value = '';
            document.getElementById('form-title').textContent = 'Technical Release Generator';
            document.getElementById('productsAffected').value = '';
            document.getElementById('category').value = 'Motors';
            document.getElementById('title').value = '';
            document.getElementById('effectiveDate').value = '';
            document.getElementById('overview').value = '';
            document.getElementById('details').value = '';
            document.getElementById('impact').value = '';
            
            const fileInput = document.getElementById('images');
            fileInput.value = '';
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('generate-headings-button').classList.add('hidden');
            imageFiles.length = 0;
            await updateRefDisplay();
        }
    </script>
</body>
</html>
