<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Release Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #a4-container {
            max-width: 210mm; 
            margin-left: auto;
            margin-right: auto;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="max-w-5xl mx-auto p-4 md:p-8">
        <!-- TABS for switching views -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6">
                <button id="generator-tab-button" onclick="switchView('form-view')" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200 ease-in-out active">
                    Generator
                </button>
                <button id="history-tab-button" onclick="switchView('history-view')" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200 ease-in-out">
                    History
                </button>
            </nav>
        </div>

        <!-- FORM VIEW -->
        <div id="form-view">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Technical Release Generator</h1>
                        <p class="text-gray-600">Fill in the details below to create a new document.</p>
                    </div>
                    <div class="text-right">
                        <label for="ref-number-input" class="block text-sm font-medium text-gray-700 text-right">Reference Number</label>
                        <input type="text" id="ref-number-input" class="w-48 mt-1 px-3 py-2 border border-gray-300 rounded-lg text-right font-bold text-blue-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                </div>
                <div class="space-y-6">
                    <!-- Form fields -->
                    <div>
                        <label for="productsAffected" class="block text-sm font-medium text-gray-700 mb-1">Products Affected</label>
                        <input type="text" id="productsAffected" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Alpha Motors, Sonesse 30 WireFree">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Release Category</label>
                        <select id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option>Motors</option> <option>Fabrics</option> <option>Hardware</option> <option>Software</option> <option>Installation Procedure</option> <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" id="title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Somfy Zigbee Motors and Tahoma Pro">
                    </div>
                    <div>
                        <label for="effectiveDate" class="block text-sm font-medium text-gray-700 mb-1">Effective Date</label>
                        <input type="date" id="effectiveDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label for="overview" class="block text-sm font-medium text-gray-700 mb-1">Overview</label>
                        <textarea id="overview" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Provide a brief overview of the technical release."></textarea>
                    </div>
                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-700 mb-1">Details</label>
                        <textarea id="details" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Provide the specific details, features, or changes."></textarea>
                    </div>
                    <div>
                        <label for="images" class="block text-sm font-medium text-gray-700 mb-1">Images</label>
                        <input type="file" id="images" multiple accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    </div>
                    <div>
                        <label for="impact" class="block text-sm font-medium text-gray-700 mb-1">Impact and Action Required</label>
                        <textarea id="impact" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Explain the impact on users and what actions are required from them."></textarea>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="generate-button" onclick="generateDocument()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                        Preview & Save
                    </button>
                </div>
            </div>
        </div>

        <!-- HISTORY VIEW -->
        <div id="history-view" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Release History</h1>
                <div class="mb-6">
                    <input type="text" id="search-input" onkeyup="searchReleases()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Search by title, reference no, or product...">
                </div>
                <div id="history-results" class="space-y-4">
                    <p class="text-gray-500">Loading history...</p>
                </div>
            </div>
        </div>

        <!-- DOCUMENT OUTPUT VIEW -->
        <div id="document-view" class="hidden">
             <div class="flex justify-end gap-2 mb-4">
                <button onclick="switchView('form-view')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Back to Editor</button>
                <button id="firebase-save-button" onclick="saveToFirebase()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                    <span id="firebase-save-text">Save to Firebase</span>
                    <span id="firebase-spinner" class="spinner hidden"></span>
                </button>
            </div>
            <div id="a4-container">
                <div id="document-output" class="bg-white p-8 md:p-12 rounded-xl shadow-lg border border-gray-200">
                     <header class="border-b pb-6 mb-8">
                        <h1 class="text-xl font-bold text-gray-800">Blind Designs Technical Release</h1>
                        <h2 id="output-title" class="text-3xl md:text-4xl font-bold text-gray-900 mt-4 break-words"></h2>
                        <div class="mt-6 grid grid-cols-3 gap-4 text-sm">
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Reference No.</p><p id="output-ref" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Release Date</p><p id="output-releaseDate" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Effective Date</p><p id="output-effectiveDate" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-600">Category</p><p id="output-category" class="text-gray-900 font-medium"></p></div>
                            <div class="bg-gray-50 p-3 rounded-lg col-span-2"><p class="font-semibold text-gray-600">Products Affected</p><p id="output-products" class="text-gray-900 font-medium break-words"></p></div>
                        </div>
                    </header>
                    <main class="space-y-8">
                        <div id="output-overview-section"><h3 class="text-xl font-bold mb-3 text-gray-800 border-b-2 border-blue-200 pb-2">Overview</h3><p id="output-overview" class="text-gray-700 leading-relaxed whitespace-pre-wrap break-words"></p></div>
                        <div id="output-details-section"><h3 class="text-xl font-bold mb-3 text-gray-800 border-b-2 border-blue-200 pb-2">Details</h3><p id="output-details" class="text-gray-700 leading-relaxed whitespace-pre-wrap break-words"></p></div>
                        <div id="output-images-section" class="hidden"><h3 class="text-xl font-bold mb-3 text-gray-800 border-b-2 border-blue-200 pb-2">Images</h3><div id="output-images" class="mt-4 grid grid-cols-2 gap-4"></div></div>
                        <div id="output-impact-section"><div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg"><div class="flex"><div class="flex-shrink-0"><svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></div><div class="ml-3"><h3 class="text-lg font-bold text-yellow-800">Impact and Action Required</h3><div class="mt-2 text-sm text-yellow-700"><p id="output-impact" class="whitespace-pre-wrap"></p></div></div></div></div></div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- IMPORTANT FIREBASE SETUP ---
        // Before running, you MUST set up your Firebase security rules.
        // The error "Missing or insufficient permissions" means your rules are incorrect.
        //
        // 1. Go to your Firebase Console -> Build -> Firestore Database -> Rules tab
        // 2. Replace the default rules with these:
        /*
            rules_version = '2';
            service cloud.firestore {
              match /databases/{database}/documents {
                // This rule allows anyone to read/list the documents in the 'releases'
                // collection, and allows anyone to create new ones. The 'read' permission
                // includes 'get' (for single documents) and 'list' (for collections).
                match /releases/{releaseId} {
                  allow read, write: if true;
                }
              }
            }
        */
        //
        // 3. Go to your Firebase Console -> Build -> Storage -> Rules tab
        // 4. Replace the default rules with these:
        /*
            rules_version = '2';
            service firebase.storage {
              match /b/{bucket}/o {
                // This allows PDF files to be uploaded and read from the 'releases' folder.
                match /releases/{fileName} {
                  allow read, write: if true;
                }
              }
            }
        */
        // NOTE: These rules are for development and allow public access.
        // For a production app, you should implement user authentication.
        // --- END OF IMPORTANT SETUP ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCAnOF4XM_sYW1-s4iEM7i3JmiB7zFCSkw",
          authDomain: "tech-release-generator.firebaseapp.com",
          projectId: "tech-release-generator",
          storageBucket: "tech-release-generator.appspot.com",
          messagingSenderId: "436027193031",
          appId: "1:436027193031:web:b4235e2f0e8ce025c730e2",
          measurementId: "G-2D5WVYH83J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make functions available globally
        window.firebase = { db, storage, collection, addDoc, getDocs, ref, uploadBytes, getDownloadURL, doc, updateDoc, serverTimestamp, query, orderBy };
        
        // Load initial data for history view
        (async () => {
            try {
                await window.loadHistory();
            } catch (e) {
                // This error is almost always caused by incorrect Firebase security rules.
                console.error("Initial history load failed. This is likely a Firebase rules issue.", e);
            }
        })();
    </script>
    
    <script>
        const imageFiles = []; 
        let allReleases = []; // Cache for search

        function getNextRefNumber() {
            const year = new Date().getFullYear();
            let counter = localStorage.getItem(`releaseCounter_${year}`);
            counter = counter ? parseInt(counter, 10) : 1;
            return `TR-${year}-${counter.toString().padStart(3, '0')}`;
        }
        
        function updateRefDisplay() {
             document.getElementById('ref-number-input').value = getNextRefNumber();
        }

        document.addEventListener('DOMContentLoaded', updateRefDisplay);

        document.getElementById('images').addEventListener('change', event => {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            imageFiles.length = 0; 

            for (const file of event.target.files) {
                if (!file.type.startsWith('image/')){ continue }
                const fileData = { file: file, src: URL.createObjectURL(file) };
                imageFiles.push(fileData);
                const img = document.createElement('img');
                img.src = fileData.src;
                img.className = 'w-full h-32 object-cover rounded-lg border'; 
                preview.appendChild(img);
            }
        });

        function generateDocument() {
            const refNumber = document.getElementById('ref-number-input').value;
            const generatedRefNumber = getNextRefNumber();
            if (refNumber === generatedRefNumber) {
                const year = new Date().getFullYear();
                let counter = localStorage.getItem(`releaseCounter_${year}`);
                counter = counter ? parseInt(counter, 10) + 1 : 2;
                localStorage.setItem(`releaseCounter_${year}`, counter);
            }
            
            document.getElementById('output-ref').textContent = refNumber;
            document.getElementById('output-products').textContent = document.getElementById('productsAffected').value;
            document.getElementById('output-category').textContent = document.getElementById('category').value;
            document.getElementById('output-title').textContent = document.getElementById('title').value || 'Untitled Release';
            
            const releaseDate = new Date().toLocaleDateString('en-CA');
            const effectiveDateRaw = document.getElementById('effectiveDate').value;
            const effectiveDate = effectiveDateRaw ? new Date(effectiveDateRaw + 'T00:00:00').toLocaleDateString('en-CA') : 'TBD';

            document.getElementById('output-releaseDate').textContent = releaseDate;
            document.getElementById('output-effectiveDate').textContent = effectiveDate;
            document.getElementById('output-overview').textContent = document.getElementById('overview').value;
            document.getElementById('output-details').textContent = document.getElementById('details').value;
            document.getElementById('output-impact').textContent = document.getElementById('impact').value;

            const imagesContainer = document.getElementById('output-images');
            imagesContainer.innerHTML = '';
            if (imageFiles.length > 0) {
                document.getElementById('output-images-section').classList.remove('hidden');
                imageFiles.forEach(fileData => {
                    const img = document.createElement('img');
                    img.src = fileData.src;
                    img.className = 'w-full rounded-lg shadow-md border';
                    img.crossOrigin = "anonymous";
                    imagesContainer.appendChild(img);
                });
            } else {
                 document.getElementById('output-images-section').classList.add('hidden');
            }

            switchView('document-view');
        }

        async function saveToFirebase() {
            const button = document.getElementById('firebase-save-button');
            const buttonText = document.getElementById('firebase-save-text');
            const spinner = document.getElementById('firebase-spinner');

            buttonText.textContent = 'Saving...';
            spinner.classList.remove('hidden');
            button.disabled = true;

            try {
                // 1. Prepare data object
                const releaseData = {
                    refNumber: document.getElementById('output-ref').textContent,
                    title: document.getElementById('output-title').textContent,
                    productsAffected: document.getElementById('output-products').textContent,
                    category: document.getElementById('output-category').textContent,
                    releaseDate: document.getElementById('output-releaseDate').textContent,
                    effectiveDate: document.getElementById('output-effectiveDate').textContent,
                    overview: document.getElementById('output-overview').textContent,
                    details: document.getElementById('output-details').textContent,
                    impact: document.getElementById('output-impact').textContent,
                    createdAt: window.firebase.serverTimestamp()
                };

                // 2. Save text data to Firestore
                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, "releases"), releaseData);

                // 3. Generate PDF as a blob
                const { jsPDF } = window.jspdf;
                const content = document.getElementById('document-output');
                const canvas = await html2canvas(content, { scale: 2, useCORS: true });
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasAspectRatio = canvas.width / canvas.height;
                let finalImgWidth = pdfWidth;
                let finalImgHeight = pdfWidth / canvasAspectRatio;
                if (finalImgHeight > pdfHeight) {
                    finalImgHeight = pdfHeight;
                    finalImgWidth = pdfHeight * canvasAspectRatio;
                }
                const xOffset = (pdfWidth - finalImgWidth) / 2;
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', xOffset, 0, finalImgWidth, finalImgHeight);
                const pdfBlob = pdf.output('blob');

                // 4. Upload PDF to Firebase Storage
                const fileName = `${releaseData.refNumber}-${releaseData.title.replace(/[\s/]/g, '-')}.pdf`;
                const storageRef = window.firebase.ref(window.firebase.storage, `releases/${fileName}`);
                await window.firebase.uploadBytes(storageRef, pdfBlob);

                // 5. Get PDF URL and update Firestore document
                const downloadURL = await window.firebase.getDownloadURL(storageRef);
                await window.firebase.updateDoc(docRef, { pdfUrl: downloadURL });

                alert('Successfully saved to Firebase!');
                await window.loadHistory(); // Refresh history
                switchView('history-view'); // Switch to history view after saving

            } catch (error) {
                console.error("Error saving to Firebase: ", error);
                alert("Error saving to Firebase. Check the console for details.");
            } finally {
                buttonText.textContent = 'Save to Firebase';
                spinner.classList.add('hidden');
                button.disabled = false;
            }
        }
        
        window.loadHistory = async function() {
            try {
                const releasesRef = window.firebase.collection(window.firebase.db, "releases");
                const q = window.firebase.query(releasesRef, window.firebase.orderBy("createdAt", "desc"));
                const querySnapshot = await window.firebase.getDocs(q);
                allReleases = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayReleases(allReleases);
            } catch (error) {
                console.error("Error loading history: ", error);
                const historyResults = document.getElementById('history-results');
                historyResults.innerHTML = `
                    <div class="text-red-100 border-l-4 border-red-500 bg-red-50 p-4" role="alert">
                        <p class="font-bold text-red-800">Error Loading History</p>
                        <p class="text-red-700">Could not fetch data from the database due to a permissions error.</p>
                        <p class="mt-2 text-sm text-red-700">Please check the browser console for details and ensure your <strong>Firebase Security Rules</strong> are set up correctly as described in the comments at the top of the script tag in the HTML file.</p>
                    </div>
                `;
            }
        }

        function displayReleases(releases) {
            const container = document.getElementById('history-results');
            if (releases.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No releases found.</p>';
                return;
            }
            container.innerHTML = releases.map(release => `
                <div class="border border-gray-200 p-4 rounded-lg flex justify-between items-center hover:bg-gray-50">
                    <div>
                        <p class="font-bold text-lg text-gray-800">${release.title}</p>
                        <p class="text-sm text-gray-600">${release.refNumber} | Products: ${release.productsAffected}</p>
                    </div>
                    <a href="${release.pdfUrl}" target="_blank" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">
                        View PDF
                    </a>
                </div>
            `).join('');
        }

        window.searchReleases = function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (!searchTerm) {
                displayReleases(allReleases);
                return;
            }
            const filtered = allReleases.filter(r => 
                (r.title && r.title.toLowerCase().includes(searchTerm)) ||
                (r.refNumber && r.refNumber.toLowerCase().includes(searchTerm)) ||
                (r.productsAffected && r.productsAffected.toLowerCase().includes(searchTerm))
            );
            displayReleases(filtered);
        }

        function switchView(viewId) {
            ['form-view', 'history-view', 'document-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            ['generator-tab-button', 'history-tab-button'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });

            if (viewId === 'form-view' || viewId === 'document-view') {
                document.getElementById('generator-tab-button').classList.add('active');
            } else if (viewId === 'history-view') {
                document.getElementById('history-tab-button').classList.add('active');
            }
            
            if (viewId === 'form-view') {
                startNewRelease();
            }
        }

        function startNewRelease() {
            document.getElementById('productsAffected').value = '';
            document.getElementById('category').value = 'Motors';
            document.getElementById('title').value = '';
            document.getElementById('effectiveDate').value = '';
            document.getElementById('overview').value = '';
            document.getElementById('details').value = '';
            document.getElementById('impact').value = '';
            document.getElementById('images').value = ''; 
            document.getElementById('image-preview').innerHTML = '';
            imageFiles.length = 0;
            updateRefDisplay();
        }
    </script>
</body>
</html>
